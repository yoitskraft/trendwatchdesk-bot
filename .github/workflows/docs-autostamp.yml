name: Docs Autostamp

on:
  workflow_run:
    workflows:
      - "TrendWatchDesk Generate"              # must exactly match your charts workflow name
      - "TWD Breaking Posters (event-driven)"  # must exactly match your posters workflow name
    types: [completed]
  workflow_dispatch:

jobs:
  stamp:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Derive status env
        shell: bash
        run: |
          TRIGGER="${{ github.event.workflow_run.name }}"
          if [ -z "$TRIGGER" ]; then TRIGGER="manual"; fi
          echo "TWD_TRIGGER_NAME=$TRIGGER" >> $GITHUB_ENV
          case "$(echo "$TRIGGER" | tr '[:upper:]' '[:lower:]')" in
            *poster*) MODE="posters" ;;
            *)        MODE="charts"  ;;
          esac
          echo "TWD_MODE=$MODE" >> $GITHUB_ENV
          echo "TWD_TF=D" >> $GITHUB_ENV
          echo "TWD_BREAKING_RECENCY_MIN=720" >> $GITHUB_ENV
          echo "TWD_BREAKING_MIN_SOURCES=1" >> $GITHUB_ENV
          echo "TWD_BREAKING_FALLBACK=on" >> $GITHUB_ENV
          echo "TWD_ALLOW_RSS=on" >> $GITHUB_ENV
          echo "TWD_CHARTS_BRANCH=charts" >> $GITHUB_ENV
          echo "TWD_POSTERS_BRANCH=posters" >> $GITHUB_ENV
          echo "TWD_WATCHLIST=AAPL,MSFT,NVDA,AMD,TSLA,SPY,QQQ,GLD,AMZN,META,GOOGL" >> $GITHUB_ENV

      - name: Run autostamp
        run: python docs/autostamp.py

      - name: Commit docs if changed
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          if git diff --staged --quiet; then
            echo "No doc changes to commit."
            exit 0
          fi
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "docs: autostamp $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          git push
